
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>neutcurve.curvefits &#8212; neutcurve 0.1.0 documentation</title>
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for neutcurve.curvefits</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">==================</span>
<span class="sd">curvefits</span>
<span class="sd">==================</span>
<span class="sd">Defines :class:`CurveFits` to fit curves and display / plot results.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">math</span>

<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">matplotlib.lines</span> <span class="k">import</span> <span class="n">Line2D</span>

<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="kn">import</span> <span class="nn">neutcurve</span>
<span class="kn">from</span> <span class="nn">neutcurve.colorschemes</span> <span class="k">import</span> <span class="n">CBMARKERS</span><span class="p">,</span> <span class="n">CBPALETTE</span>


<div class="viewcode-block" id="CurveFits"><a class="viewcode-back" href="../../neutcurve.curvefits.html#neutcurve.curvefits.CurveFits">[docs]</a><span class="k">class</span> <span class="nc">CurveFits</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Fit and display :class:`neutcurve.hillcurve.HillCurve` curves.</span>

<span class="sd">    Args:</span>
<span class="sd">        `data` (pandas DataFrame)</span>
<span class="sd">            Tidy dataframe with data.</span>
<span class="sd">        `conc_col` (str)</span>
<span class="sd">            Column in `data` with concentrations of serum.</span>
<span class="sd">        `fracinf_col` (str)</span>
<span class="sd">            Column in `data` with fraction infectivity.</span>
<span class="sd">        `serum_col` (str)</span>
<span class="sd">            Column in `data` with serum name.</span>
<span class="sd">        `virus_col` (str)</span>
<span class="sd">            Column in `data` with name of virus being neutralized.</span>
<span class="sd">        `replicate_col` (str`)</span>
<span class="sd">            Column in data with name of replicate of this measurement.</span>
<span class="sd">            Replicates must all have the same concentrations for each</span>
<span class="sd">            serum / virus combination. Replicates can **not** be named</span>
<span class="sd">            &#39;average&#39; as we compute the average from the replicates.</span>
<span class="sd">        `fixbottom` (`False` or float)</span>
<span class="sd">            Same meaning as for :class:`neutcurve.hillcurve.HillCurve`.</span>
<span class="sd">        `fixtop` (`False` or float)</span>
<span class="sd">            Same meaning as for :class:`neutcurve.hillcurve.HillCurve`.</span>

<span class="sd">    Attributes of a :class:`CurveFits` include all args except `data` plus:</span>
<span class="sd">        `df` (pandas DataFrame)</span>
<span class="sd">            Copy of `data` that only has relevant columns, has additional rows</span>
<span class="sd">            with `replicate_col` of &#39;average&#39; that hold replicate averages, and</span>
<span class="sd">            added columns &#39;stderr&#39; (standard error of fraction infectivity</span>
<span class="sd">            for &#39;average&#39; if multiple replicates, otherwise `nan`).</span>
<span class="sd">        `sera` (list)</span>
<span class="sd">            List of all serum names in `serum_col` of `data`, in order</span>
<span class="sd">            they occur in `data`.</span>
<span class="sd">        `viruses` (dict)</span>
<span class="sd">            For each serum in `sera`, `viruses[serum]` gives all viruses</span>
<span class="sd">            for that serum in the order they occur in `data`.</span>
<span class="sd">        `replicates` (dict)</span>
<span class="sd">            `replicates[(serum, virus)]` is list of all replicates for</span>
<span class="sd">            that serum and virus in the order they occur in `data`.</span>
<span class="sd">        `allviruses` (list)</span>
<span class="sd">            List of all viruses.</span>
<span class="sd">        `allreplicates` (list)</span>
<span class="sd">            List of all replicates.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">data</span><span class="p">,</span>
                 <span class="o">*</span><span class="p">,</span>
                 <span class="n">conc_col</span><span class="o">=</span><span class="s1">&#39;concentration&#39;</span><span class="p">,</span>
                 <span class="n">fracinf_col</span><span class="o">=</span><span class="s1">&#39;fraction infectivity&#39;</span><span class="p">,</span>
                 <span class="n">serum_col</span><span class="o">=</span><span class="s1">&#39;serum&#39;</span><span class="p">,</span>
                 <span class="n">virus_col</span><span class="o">=</span><span class="s1">&#39;virus&#39;</span><span class="p">,</span>
                 <span class="n">replicate_col</span><span class="o">=</span><span class="s1">&#39;replicate&#39;</span><span class="p">,</span>
                 <span class="n">fixbottom</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                 <span class="n">fixtop</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                 <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;See main class docstring.&quot;&quot;&quot;</span>
        <span class="c1"># make args into attributes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conc_col</span> <span class="o">=</span> <span class="n">conc_col</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fracinf_col</span> <span class="o">=</span> <span class="n">fracinf_col</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">serum_col</span> <span class="o">=</span> <span class="n">serum_col</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">virus_col</span> <span class="o">=</span> <span class="n">virus_col</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">replicate_col</span> <span class="o">=</span> <span class="n">replicate_col</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fixbottom</span> <span class="o">=</span> <span class="n">fixbottom</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fixtop</span> <span class="o">=</span> <span class="n">fixtop</span>

        <span class="c1"># check for required columns</span>
        <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">serum_col</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">virus_col</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">replicate_col</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">conc_col</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fracinf_col</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cols</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">cols</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;duplicate column names:</span><span class="se">\n\t</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cols</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">cols</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="nb">set</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;`data` lacks required columns, which are:</span><span class="se">\n\t</span><span class="s1">&#39;</span> <span class="o">+</span>
                             <span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cols</span><span class="p">))</span>

        <span class="c1"># create `self.df`, ensure that replicates are str rather than number</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">cols</span><span class="p">]</span>
                   <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="o">**</span><span class="p">{</span><span class="n">replicate_col</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">replicate_col</span><span class="p">]</span>
                                                        <span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">))</span>
                              <span class="p">})</span>
                   <span class="p">)</span>

        <span class="c1"># create sera / viruses / replicates attributes, error check them</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sera</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">serum_col</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">viruses</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">replicates</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">serum</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sera</span><span class="p">:</span>
            <span class="n">serum_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;</span><span class="si">{self.serum_col}</span><span class="s2"> == @serum&quot;</span><span class="p">)</span>
            <span class="n">serum_viruses</span> <span class="o">=</span> <span class="n">serum_data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">virus_col</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">viruses</span><span class="p">[</span><span class="n">serum</span><span class="p">]</span> <span class="o">=</span> <span class="n">serum_viruses</span>
            <span class="k">for</span> <span class="n">virus</span> <span class="ow">in</span> <span class="n">serum_viruses</span><span class="p">:</span>
                <span class="n">virus_data</span> <span class="o">=</span> <span class="n">serum_data</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;</span><span class="si">{self.virus_col}</span><span class="s2"> == @virus&quot;</span><span class="p">)</span>
                <span class="n">virus_reps</span> <span class="o">=</span> <span class="n">virus_data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">replicate_col</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                <span class="k">if</span> <span class="s1">&#39;average&#39;</span> <span class="ow">in</span> <span class="n">virus_reps</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;A replicate is named &quot;average&quot;. This is &#39;</span>
                                     <span class="s1">&#39;not allowed as that name is used for &#39;</span>
                                     <span class="s1">&#39;replicate averages.&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">replicates</span><span class="p">[(</span><span class="n">serum</span><span class="p">,</span> <span class="n">virus</span><span class="p">)]</span> <span class="o">=</span> <span class="n">virus_reps</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;average&#39;</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">rep1</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">virus_reps</span><span class="p">):</span>
                    <span class="n">conc1</span> <span class="o">=</span> <span class="p">(</span><span class="n">virus_data</span>
                             <span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;</span><span class="si">{self.replicate_col}</span><span class="s2"> == @rep1&quot;</span><span class="p">)</span>
                             <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">conc_col</span><span class="p">]</span>
                             <span class="o">.</span><span class="n">sort_values</span><span class="p">()</span>
                             <span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                             <span class="p">)</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">conc1</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">conc1</span><span class="p">)):</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;duplicate concentrations for &#39;</span>
                                         <span class="n">f</span><span class="s2">&quot;</span><span class="si">{serum}</span><span class="s2">, </span><span class="si">{virus}</span><span class="s2">, </span><span class="si">{rep1}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">rep2</span> <span class="ow">in</span> <span class="n">virus_reps</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:]:</span>
                        <span class="n">conc2</span> <span class="o">=</span> <span class="p">(</span><span class="n">virus_data</span>
                                 <span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;</span><span class="si">{self.replicate_col}</span><span class="s2"> == @rep1&quot;</span><span class="p">)</span>
                                 <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">conc_col</span><span class="p">]</span>
                                 <span class="o">.</span><span class="n">sort_values</span><span class="p">()</span>
                                 <span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                                 <span class="p">)</span>
                        <span class="k">if</span> <span class="n">conc1</span> <span class="o">!=</span> <span class="n">conc2</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;replicates </span><span class="si">{rep1}</span><span class="s2"> and </span><span class="si">{rep2}</span><span class="s2"> &quot;</span>
                                             <span class="s1">&#39;have different concentrations &#39;</span>
                                             <span class="n">f</span><span class="s2">&quot;for </span><span class="si">{serum}</span><span class="s2">, </span><span class="si">{virus}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># compute replicate average and add &#39;stderr&#39;</span>
        <span class="k">if</span> <span class="s1">&#39;stderr&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;`data` has column &quot;stderr&quot;&#39;</span><span class="p">)</span>
        <span class="n">avg_df</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span>
                  <span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">serum_col</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">virus_col</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">conc_col</span><span class="p">])</span>
                  <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">fracinf_col</span><span class="p">]</span>
                  <span class="c1"># sem is sample stderr, evaluates to NaN when just 1 rep</span>
                  <span class="o">.</span><span class="n">aggregate</span><span class="p">([</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="s1">&#39;sem&#39;</span><span class="p">,</span> <span class="s1">&#39;count&#39;</span><span class="p">])</span>
                  <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;mean&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">fracinf_col</span><span class="p">,</span>
                                   <span class="s1">&#39;sem&#39;</span><span class="p">:</span> <span class="s1">&#39;stderr&#39;</span><span class="p">,</span>
                                   <span class="p">})</span>
                  <span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
                  <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="o">**</span><span class="p">{</span><span class="n">replicate_col</span><span class="p">:</span> <span class="s1">&#39;average&#39;</span><span class="p">})</span>
                  <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">,</span> <span class="n">avg_df</span><span class="p">],</span>
                            <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                            <span class="n">sort</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_hillcurves</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># curves computed by `getCurve` cached here</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fitparams</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># cache data frame computed by `fitParams`</span>

<div class="viewcode-block" id="CurveFits.getCurve"><a class="viewcode-back" href="../../neutcurve.curvefits.html#neutcurve.curvefits.CurveFits.getCurve">[docs]</a>    <span class="k">def</span> <span class="nf">getCurve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">serum</span><span class="p">,</span> <span class="n">virus</span><span class="p">,</span> <span class="n">replicate</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the fitted curve for this sample.</span>

<span class="sd">        Args:</span>
<span class="sd">            `serum` (str)</span>
<span class="sd">                Name of a valid serum.</span>
<span class="sd">            `virus` (str)</span>
<span class="sd">                Name of a valid virus for `serum`.</span>
<span class="sd">            `replicate` (str)</span>
<span class="sd">                Name of a valid replicate for `serum` and `virus`, or</span>
<span class="sd">                &#39;average&#39; for the average of all replicates.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A :class:`neutcurve.hillcurve.HillCurve`.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="n">serum</span><span class="p">,</span> <span class="n">virus</span><span class="p">,</span> <span class="n">replicate</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hillcurves</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">serum</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sera</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;invalid `serum` of </span><span class="si">{serum}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">virus</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">viruses</span><span class="p">[</span><span class="n">serum</span><span class="p">]:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;invalid `virus` of </span><span class="si">{virus}</span><span class="s2"> for &quot;</span>
                                 <span class="n">f</span><span class="s2">&quot;`serum` of </span><span class="si">{serum}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">replicate</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">replicates</span><span class="p">[(</span><span class="n">serum</span><span class="p">,</span> <span class="n">virus</span><span class="p">)]:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;invalid `replicate` of </span><span class="si">{replicate}</span><span class="s2"> for &quot;</span>
                                 <span class="n">f</span><span class="s2">&quot;`serum` of </span><span class="si">{serum}</span><span class="s2"> and `virus` of </span><span class="si">{virus}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="n">idata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;(</span><span class="si">{self.serum_col}</span><span class="s2"> == @serum) &amp; &quot;</span>
                                  <span class="n">f</span><span class="s2">&quot;(</span><span class="si">{self.virus_col}</span><span class="s2"> == @virus) &amp; &quot;</span>
                                  <span class="n">f</span><span class="s2">&quot;(</span><span class="si">{self.replicate_col}</span><span class="s2"> == @replicate)&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">idata</span><span class="p">[</span><span class="s1">&#39;stderr&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
                <span class="n">fs_stderr</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">elif</span> <span class="n">idata</span><span class="p">[</span><span class="s1">&#39;stderr&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;`stderr` has some but not all entries NaN&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fs_stderr</span> <span class="o">=</span> <span class="n">idata</span><span class="p">[</span><span class="s1">&#39;stderr&#39;</span><span class="p">]</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">curve</span> <span class="o">=</span> <span class="n">neutcurve</span><span class="o">.</span><span class="n">HillCurve</span><span class="p">(</span><span class="n">cs</span><span class="o">=</span><span class="n">idata</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">conc_col</span><span class="p">],</span>
                                            <span class="n">fs</span><span class="o">=</span><span class="n">idata</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">fracinf_col</span><span class="p">],</span>
                                            <span class="n">fs_stderr</span><span class="o">=</span><span class="n">fs_stderr</span><span class="p">,</span>
                                            <span class="n">fixbottom</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fixbottom</span><span class="p">,</span>
                                            <span class="n">fixtop</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fixtop</span><span class="p">,</span>
                                            <span class="p">)</span>
            <span class="k">except</span> <span class="ne">RuntimeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">idata</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s1">&#39;temp.csv&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="c1"># following here: https://stackoverflow.com/a/46091127</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Error while fitting HillCurve for &#39;</span>
                                   <span class="n">f</span><span class="s2">&quot;serum </span><span class="si">{serum}</span><span class="s2">, virus </span><span class="si">{virus}</span><span class="s2">, &quot;</span>
                                   <span class="n">f</span><span class="s2">&quot;replicate </span><span class="si">{replicate}</span><span class="s2">.</span><span class="se">\n</span><span class="s2">Data are:</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span>
                                   <span class="nb">str</span><span class="p">(</span><span class="n">idata</span><span class="p">))</span> <span class="kn">from</span> <span class="nn">e</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_hillcurves</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">curve</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hillcurves</span><span class="p">[</span><span class="n">key</span><span class="p">]</span></div>

<div class="viewcode-block" id="CurveFits.fitParams"><a class="viewcode-back" href="../../neutcurve.curvefits.html#neutcurve.curvefits.CurveFits.fitParams">[docs]</a>    <span class="k">def</span> <span class="nf">fitParams</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                  <span class="o">*</span><span class="p">,</span>
                  <span class="n">average_only</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                  <span class="n">ics</span><span class="o">=</span><span class="p">(</span><span class="mi">50</span><span class="p">,),</span>
                  <span class="n">ics_precision</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                  <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get data frame with curve fitting parameters.</span>

<span class="sd">        Args:</span>
<span class="sd">            `average_only` (bool)</span>
<span class="sd">                If `True`, only get parameters for average across replicates.</span>
<span class="sd">            `ics` (iterable)</span>
<span class="sd">                Include ICXX for each number in this list, where the number</span>
<span class="sd">                is the percent neutralized. So if `ics` only contains 50,</span>
<span class="sd">                we include the IC50. If it includes 95, we include the IC95.</span>
<span class="sd">            `ics_precision` (int)</span>
<span class="sd">                Include this many digits after decimal when creating the</span>
<span class="sd">                ICXX columns.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A pandas DataFrame with fit parameters for each serum / virus /</span>
<span class="sd">            replicate as defined for a :mod:`neutcurve.hillcurve.HillCurve`.</span>
<span class="sd">            Columns:</span>

<span class="sd">              - &#39;serum&#39;</span>
<span class="sd">              - &#39;virus&#39;</span>
<span class="sd">              - &#39;replicate&#39;</span>
<span class="sd">              - &#39;nreplicates&#39;: number of replicates for average, NaN otherwise.</span>
<span class="sd">              - &#39;icXX&#39;: ICXX or its bound as a number, where `XX` is each</span>
<span class="sd">                number in `ics`.</span>
<span class="sd">              - &#39;icXX_bound&#39;: string indicating if ICXX interpolated from data,</span>
<span class="sd">                or is an upper or lower bound.</span>
<span class="sd">              - &#39;icXX_str&#39;: ICXX represented as string, with &gt; or &lt; indicating</span>
<span class="sd">                if it is an upper or lower bound.</span>
<span class="sd">              - &#39;midpoint&#39;: midpoint of curve, same as IC50 only if bottom</span>
<span class="sd">                and top are 0 and 1.</span>
<span class="sd">              - &#39;slope&#39;: Hill slope of curve.</span>
<span class="sd">              - &#39;top&#39;: top of curve.</span>
<span class="sd">              - &#39;bottom&#39;: bottom of curve.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ics</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">ics</span><span class="p">)</span>
        <span class="n">ic_colprefixes</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="s2">&quot;ic{{:.</span><span class="si">{ics_precision}</span><span class="s2">f}}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span> <span class="k">for</span> <span class="n">ic</span> <span class="ow">in</span> <span class="n">ics</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ic_colprefixes</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">ic_colprefixes</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;column names for ICXX not unique.</span><span class="se">\n</span><span class="s1">&#39;</span>
                             <span class="s1">&#39;Either you have duplicate entries in `ics` &#39;</span>
                             <span class="s1">&#39;or you need to increase `ics_precision`.&#39;</span><span class="p">)</span>

        <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="n">average_only</span><span class="p">,</span> <span class="n">ics</span><span class="p">,</span> <span class="n">ics_precision</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fitparams</span><span class="p">:</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
            <span class="n">params</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;midpoint&#39;</span><span class="p">,</span> <span class="s1">&#39;slope&#39;</span><span class="p">,</span> <span class="s1">&#39;top&#39;</span><span class="p">,</span> <span class="s1">&#39;bottom&#39;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">serum</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sera</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">virus</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">viruses</span><span class="p">[</span><span class="n">serum</span><span class="p">]:</span>
                    <span class="n">replicates</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">replicates</span><span class="p">[(</span><span class="n">serum</span><span class="p">,</span> <span class="n">virus</span><span class="p">)]</span>
                    <span class="n">nreplicates</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">r</span> <span class="o">!=</span> <span class="s1">&#39;average&#39;</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">replicates</span><span class="p">)</span>
                    <span class="k">assert</span> <span class="n">nreplicates</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">replicates</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="n">average_only</span><span class="p">:</span>
                        <span class="n">replicates</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;average&#39;</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">replicate</span> <span class="ow">in</span> <span class="n">replicates</span><span class="p">:</span>
                        <span class="n">curve</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getCurve</span><span class="p">(</span><span class="n">serum</span><span class="o">=</span><span class="n">serum</span><span class="p">,</span>
                                              <span class="n">virus</span><span class="o">=</span><span class="n">virus</span><span class="p">,</span>
                                              <span class="n">replicate</span><span class="o">=</span><span class="n">replicate</span>
                                              <span class="p">)</span>
                        <span class="n">d</span><span class="p">[</span><span class="s1">&#39;serum&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">serum</span><span class="p">)</span>
                        <span class="n">d</span><span class="p">[</span><span class="s1">&#39;virus&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">virus</span><span class="p">)</span>
                        <span class="n">d</span><span class="p">[</span><span class="s1">&#39;replicate&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">replicate</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">replicate</span> <span class="o">==</span> <span class="s1">&#39;average&#39;</span><span class="p">:</span>
                            <span class="n">d</span><span class="p">[</span><span class="s1">&#39;nreplicates&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nreplicates</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">d</span><span class="p">[</span><span class="s1">&#39;nreplicates&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="s1">&#39;nan&#39;</span><span class="p">))</span>
                        <span class="k">for</span> <span class="n">ic</span><span class="p">,</span> <span class="n">colprefix</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">ics</span><span class="p">,</span> <span class="n">ic_colprefixes</span><span class="p">):</span>
                            <span class="n">f</span> <span class="o">=</span> <span class="n">ic</span> <span class="o">/</span> <span class="mi">100</span>
                            <span class="n">d</span><span class="p">[</span><span class="n">colprefix</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">curve</span><span class="o">.</span><span class="n">icXX</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;bound&#39;</span><span class="p">))</span>
                            <span class="n">d</span><span class="p">[</span><span class="n">f</span><span class="s2">&quot;</span><span class="si">{colprefix}</span><span class="s2">_bound&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">curve</span><span class="o">.</span><span class="n">icXX_bound</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>
                            <span class="n">d</span><span class="p">[</span><span class="n">f</span><span class="s2">&quot;</span><span class="si">{colprefix}</span><span class="s2">_str&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">curve</span><span class="o">.</span><span class="n">icXX_str</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>
                        <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">params</span><span class="p">:</span>
                            <span class="n">d</span><span class="p">[</span><span class="n">param</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">curve</span><span class="p">,</span> <span class="n">param</span><span class="p">))</span>

            <span class="n">ic_cols</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">prefix</span> <span class="ow">in</span> <span class="n">ic_colprefixes</span><span class="p">:</span>
                <span class="n">ic_cols</span> <span class="o">+=</span> <span class="p">[</span><span class="n">prefix</span><span class="p">,</span> <span class="n">f</span><span class="s2">&quot;</span><span class="si">{prefix}</span><span class="s2">_bound&quot;</span><span class="p">,</span> <span class="n">f</span><span class="s2">&quot;</span><span class="si">{prefix}</span><span class="s2">_str&quot;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_fitparams</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
                    <span class="p">[[</span><span class="s1">&#39;serum&#39;</span><span class="p">,</span> <span class="s1">&#39;virus&#39;</span><span class="p">,</span> <span class="s1">&#39;replicate&#39;</span><span class="p">,</span> <span class="s1">&#39;nreplicates&#39;</span><span class="p">]</span>
                     <span class="o">+</span> <span class="n">ic_cols</span> <span class="o">+</span> <span class="n">params</span><span class="p">]</span>
                    <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">nreplicates</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;nreplicates&#39;</span><span class="p">]</span>
                                                   <span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;Int64&#39;</span><span class="p">))</span>
                            <span class="p">)</span>
                    <span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fitparams</span><span class="p">[</span><span class="n">key</span><span class="p">]</span></div>

<div class="viewcode-block" id="CurveFits.plotSera"><a class="viewcode-back" href="../../neutcurve.curvefits.html#neutcurve.curvefits.CurveFits.plotSera">[docs]</a>    <span class="k">def</span> <span class="nf">plotSera</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="o">*</span><span class="p">,</span>
                 <span class="n">ncol</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
                 <span class="n">nrow</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">sera</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">,</span>
                 <span class="n">viruses</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">,</span>
                 <span class="n">colors</span><span class="o">=</span><span class="n">CBPALETTE</span><span class="p">,</span>
                 <span class="n">markers</span><span class="o">=</span><span class="n">CBMARKERS</span><span class="p">,</span>
                 <span class="n">max_viruses_per_subplot</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                 <span class="n">multi_serum_subplots</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                 <span class="n">all_subplots</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;WT&#39;</span><span class="p">,</span> <span class="s1">&#39;wt&#39;</span><span class="p">,</span> <span class="s1">&#39;wildtype&#39;</span><span class="p">,</span> <span class="s1">&#39;Wildtype&#39;</span><span class="p">,</span>
                               <span class="s1">&#39;wild type&#39;</span><span class="p">,</span> <span class="s1">&#39;Wild type&#39;</span><span class="p">),</span>
                 <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
                 <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Plot grid with replicate-average of viruses for each serum.</span>

<span class="sd">        Args:</span>
<span class="sd">            `ncol`, `nrow` (int or `None`)</span>
<span class="sd">                Specify one of these to set number of columns or rows.</span>
<span class="sd">            `sera` (&#39;all&#39; or list)</span>
<span class="sd">                Sera to include on plot, in this order.</span>
<span class="sd">            `viruses` (&#39;all&#39; or list)</span>
<span class="sd">                Viruses to include on plot.</span>
<span class="sd">            `colors` (iterable)</span>
<span class="sd">                List of colors for different replicates.</span>
<span class="sd">            `markers` (iterable)</span>
<span class="sd">                List of markers for different replicates.</span>
<span class="sd">            `max_viruses_per_subplot` (int)</span>
<span class="sd">                Maximum number of viruses to show on any subplot.</span>
<span class="sd">            `multi_serum_subplots` (bool)</span>
<span class="sd">                If a serum has more than `max_virus_per_subplot` viruses,</span>
<span class="sd">                do we make multiple subplots for it or raise an error?</span>
<span class="sd">            `all_subplots` (iterable)</span>
<span class="sd">                If making multiple subplots for serum, which samples</span>
<span class="sd">                do we show on all subplots? These are also shown first.</span>
<span class="sd">            `**kwargs`</span>
<span class="sd">                Other keyword arguments that can be passed to</span>
<span class="sd">                :meth:`CurveFits.plotGrid`.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The 2-tuple `(fig, axes)` of matplotlib figure and 2D axes array.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">sera</span><span class="p">,</span> <span class="n">viruses</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sera_viruses_lists</span><span class="p">(</span><span class="n">sera</span><span class="p">,</span> <span class="n">viruses</span><span class="p">)</span>
        <span class="n">viruses</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">viruses</span><span class="p">)</span>

        <span class="n">nplottable</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">colors</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">markers</span><span class="p">))</span>  <span class="c1"># max curves per plot</span>
        <span class="k">if</span> <span class="n">nplottable</span> <span class="o">&lt;</span> <span class="n">max_viruses_per_subplot</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;`max_viruses_per_subplot` larger than &#39;</span>
                             <span class="s1">&#39;number of colors or markers&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">max_viruses_per_subplot</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;`max_viruses_per_subplot` must be at least 1&#39;</span><span class="p">)</span>

        <span class="c1"># can we share color scheme for viruses among all subplots?</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">viruses</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">colors</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">markers</span><span class="p">)):</span>
            <span class="n">virus_to_color_marker</span> <span class="o">=</span> <span class="p">{</span><span class="n">v</span><span class="p">:</span> <span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">m</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">m</span><span class="p">)</span> <span class="ow">in</span>
                                     <span class="nb">zip</span><span class="p">(</span><span class="n">viruses</span><span class="p">,</span> <span class="n">colors</span><span class="p">,</span> <span class="n">markers</span><span class="p">)}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">virus_to_color_marker</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Build a list of plots appropriate for `plotGrid`.</span>
        <span class="c1"># Code is complicated because we could have several curve</span>
        <span class="c1"># per serum, and in that case need to share viruses in</span>
        <span class="c1"># `all_subplots` among curves.</span>
        <span class="n">plotlist</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">serum</span> <span class="ow">in</span> <span class="n">sera</span><span class="p">:</span>
            <span class="n">curvelist</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">ivirus</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">serum_shared_viruses</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">viruses</span><span class="p">[</span><span class="n">serum</span><span class="p">]</span> <span class="k">if</span>
                                    <span class="p">(</span><span class="n">v</span> <span class="ow">in</span> <span class="n">viruses</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">v</span> <span class="ow">in</span> <span class="n">all_subplots</span><span class="p">)]</span>
            <span class="n">serum_unshared_viruses</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">viruses</span><span class="p">[</span><span class="n">serum</span><span class="p">]</span> <span class="k">if</span>
                                      <span class="p">(</span><span class="n">v</span> <span class="ow">in</span> <span class="n">viruses</span><span class="p">)</span> <span class="ow">and</span>
                                      <span class="p">(</span><span class="n">v</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">all_subplots</span><span class="p">)]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">serum_shared_viruses</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">max_viruses_per_subplot</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;serum </span><span class="si">{serum}</span><span class="s2"> has too many subplot-shared &quot;</span>
                                 <span class="s1">&#39;viruses (in `all_subplots`) relative to &#39;</span>
                                 <span class="s1">&#39;value of `max_viruses_per_subplot`&#39;</span><span class="p">)</span>
            <span class="n">shared_curvelist</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">virus</span> <span class="ow">in</span> <span class="n">serum_shared_viruses</span> <span class="o">+</span> <span class="n">serum_unshared_viruses</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">ivirus</span> <span class="o">&gt;=</span> <span class="n">max_viruses_per_subplot</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">multi_serum_subplots</span><span class="p">:</span>
                        <span class="n">plotlist</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">serum</span><span class="p">,</span> <span class="n">curvelist</span><span class="p">))</span>
                        <span class="n">curvelist</span> <span class="o">=</span> <span class="p">[</span><span class="n">curve</span> <span class="k">for</span> <span class="n">curve</span> <span class="ow">in</span> <span class="n">shared_curvelist</span><span class="p">]</span>
                        <span class="n">ivirus</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">curvelist</span><span class="p">)</span>
                        <span class="k">assert</span> <span class="n">ivirus</span> <span class="o">&lt;</span> <span class="n">max_viruses_per_subplot</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;serum </span><span class="si">{serum}</span><span class="s2"> has more than &quot;</span>
                                         <span class="s1">&#39;`max_viruses_per_subplot` viruses &#39;</span>
                                         <span class="s1">&#39;and `multi_serum_subplots` is False&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">virus_to_color_marker</span><span class="p">:</span>
                    <span class="n">color</span><span class="p">,</span> <span class="n">marker</span> <span class="o">=</span> <span class="n">virus_to_color_marker</span><span class="p">[</span><span class="n">virus</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">color</span> <span class="o">=</span> <span class="n">colors</span><span class="p">[</span><span class="n">ivirus</span><span class="p">]</span>
                    <span class="n">marker</span> <span class="o">=</span> <span class="n">markers</span><span class="p">[</span><span class="n">ivirus</span><span class="p">]</span>
                <span class="n">curvelist</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;serum&#39;</span><span class="p">:</span> <span class="n">serum</span><span class="p">,</span>
                                  <span class="s1">&#39;virus&#39;</span><span class="p">:</span> <span class="n">virus</span><span class="p">,</span>
                                  <span class="s1">&#39;replicate&#39;</span><span class="p">:</span> <span class="s1">&#39;average&#39;</span><span class="p">,</span>
                                  <span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="n">virus</span><span class="p">,</span>
                                  <span class="s1">&#39;color&#39;</span><span class="p">:</span> <span class="n">color</span><span class="p">,</span>
                                  <span class="s1">&#39;marker&#39;</span><span class="p">:</span> <span class="n">marker</span><span class="p">,</span>
                                  <span class="p">})</span>
                <span class="k">if</span> <span class="n">virus</span> <span class="ow">in</span> <span class="n">serum_shared_viruses</span><span class="p">:</span>
                    <span class="n">shared_curvelist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">curvelist</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">ivirus</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">curvelist</span><span class="p">:</span>
                <span class="n">plotlist</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">serum</span><span class="p">,</span> <span class="n">curvelist</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">plotlist</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;no curves for these sera / viruses&#39;</span><span class="p">)</span>

        <span class="c1"># get number of columns</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">nrow</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">ncol</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;either `ncol` or `nrow` must be `None`&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">nrow</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">and</span> <span class="n">nrow</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">ncol</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">plotlist</span><span class="p">)</span> <span class="o">/</span> <span class="n">nrow</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">ncol</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">and</span> <span class="n">ncol</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;`nrow` or `ncol` must be integer &gt; 0&#39;</span><span class="p">)</span>

        <span class="c1"># convert plotlist to plots dict for `plotGrid`</span>
        <span class="n">plots</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">iplot</span><span class="p">,</span> <span class="n">plot</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">plotlist</span><span class="p">):</span>
            <span class="n">plots</span><span class="p">[(</span><span class="n">iplot</span> <span class="o">//</span> <span class="n">ncol</span><span class="p">,</span> <span class="n">iplot</span> <span class="o">%</span> <span class="n">ncol</span><span class="p">)]</span> <span class="o">=</span> <span class="n">plot</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">plotGrid</span><span class="p">(</span><span class="n">plots</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="CurveFits.plotAverages"><a class="viewcode-back" href="../../neutcurve.curvefits.html#neutcurve.curvefits.CurveFits.plotAverages">[docs]</a>    <span class="k">def</span> <span class="nf">plotAverages</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                     <span class="o">*</span><span class="p">,</span>
                     <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span>
                     <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span>
                     <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
                     <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Plot grid with a curve for each serum / virus pair.</span>

<span class="sd">        Args:</span>
<span class="sd">            `color` (str)</span>
<span class="sd">                Color the curves.</span>
<span class="sd">            `marker` (str)</span>
<span class="sd">                Marker for the curves.</span>
<span class="sd">            `**kwargs`</span>
<span class="sd">                Other keyword arguments that can be passed to</span>
<span class="sd">                :meth:`CurveFits.plotReplicates`.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The 2-tuple `(fig, axes)` of matplotlib figure and 2D axes array.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">plotReplicates</span><span class="p">(</span><span class="n">average_only</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                   <span class="n">colors</span><span class="o">=</span><span class="p">[</span><span class="n">color</span><span class="p">],</span>
                                   <span class="n">markers</span><span class="o">=</span><span class="p">[</span><span class="n">marker</span><span class="p">],</span>
                                   <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="CurveFits.plotReplicates"><a class="viewcode-back" href="../../neutcurve.curvefits.html#neutcurve.curvefits.CurveFits.plotReplicates">[docs]</a>    <span class="k">def</span> <span class="nf">plotReplicates</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                       <span class="o">*</span><span class="p">,</span>
                       <span class="n">ncol</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
                       <span class="n">nrow</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                       <span class="n">sera</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">,</span>
                       <span class="n">viruses</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">,</span>
                       <span class="n">colors</span><span class="o">=</span><span class="n">CBPALETTE</span><span class="p">,</span>
                       <span class="n">markers</span><span class="o">=</span><span class="n">CBMARKERS</span><span class="p">,</span>
                       <span class="n">subplot_titles</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">{serum}</span><span class="s1"> vs </span><span class="si">{virus}</span><span class="s1">&#39;</span><span class="p">,</span>
                       <span class="n">show_average</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                       <span class="n">average_only</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                       <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
                       <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Plot grid with replicates for each serum / virus on same plot.</span>

<span class="sd">        Args:</span>
<span class="sd">            `ncol`, `nrow` (int or `None`)</span>
<span class="sd">                Specify one of these to set number of columns or rows.</span>
<span class="sd">            `sera` (&#39;all&#39; or list)</span>
<span class="sd">                Sera to include on plot, in this order.</span>
<span class="sd">            `viruses` (&#39;all&#39; or list)</span>
<span class="sd">                Viruses to include on plot, in this order.</span>
<span class="sd">            `colors` (iterable)</span>
<span class="sd">                List of colors for different replicates.</span>
<span class="sd">            `markers` (iterable)</span>
<span class="sd">                List of markers for different replicates.</span>
<span class="sd">            `subplot_titles` (str)</span>
<span class="sd">                Format string to build subplot titles from *serum* and *virus*.</span>
<span class="sd">            `show_average` (bool)</span>
<span class="sd">                Include the replicate-average as a &quot;replicate&quot; in plots.</span>
<span class="sd">            `average_only` (bool)</span>
<span class="sd">                Show **only** the replicate-average on each plot. No</span>
<span class="sd">                legend in this case.</span>
<span class="sd">            `**kwargs`</span>
<span class="sd">                Other keyword arguments that can be passed to</span>
<span class="sd">                :meth:`CurveFits.plotGrid`.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The 2-tuple `(fig, axes)` of matplotlib figure and 2D axes array.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">subplot_titles</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">virus</span><span class="o">=</span><span class="s1">&#39;dummy&#39;</span><span class="p">,</span> <span class="n">serum</span><span class="o">=</span><span class="s1">&#39;dummy&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;`subplot_titles` </span><span class="si">{subplot_titles}</span><span class="s2"> invalid. &quot;</span>
                             <span class="s1">&#39;Should have format keys only for virus &#39;</span>
                             <span class="s1">&#39;and serum&#39;</span><span class="p">)</span>

        <span class="n">sera</span><span class="p">,</span> <span class="n">viruses</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sera_viruses_lists</span><span class="p">(</span><span class="n">sera</span><span class="p">,</span> <span class="n">viruses</span><span class="p">)</span>

        <span class="c1"># get replicates and make sure there aren&#39;t too many</span>
        <span class="n">nplottable</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">colors</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">markers</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">average_only</span><span class="p">:</span>
            <span class="n">replicates</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;average&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">replicates</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">show_average</span><span class="p">:</span>
                <span class="n">replicates</span><span class="p">[</span><span class="s1">&#39;average&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">for</span> <span class="n">serum</span><span class="p">,</span> <span class="n">virus</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="n">sera</span><span class="p">,</span> <span class="n">viruses</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">virus</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">viruses</span><span class="p">[</span><span class="n">serum</span><span class="p">]:</span>
                    <span class="k">for</span> <span class="n">replicate</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">replicates</span><span class="p">[(</span><span class="n">serum</span><span class="p">,</span> <span class="n">virus</span><span class="p">)]:</span>
                        <span class="k">if</span> <span class="n">replicate</span> <span class="o">!=</span> <span class="s1">&#39;average&#39;</span><span class="p">:</span>
                            <span class="n">replicates</span><span class="p">[</span><span class="n">replicate</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">replicates</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">(</span><span class="n">replicates</span><span class="p">)</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">replicates</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">nplottable</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Too many unique replicates. There are&#39;</span>
                             <span class="n">f</span><span class="s2">&quot;{len(replicates)} ({&#39;, &#39;.join(replicates)}) &quot;</span>
                             <span class="n">f</span><span class="s2">&quot;but only </span><span class="si">{nplottable}</span><span class="s2"> `colors` or `markers`.&quot;</span><span class="p">)</span>

        <span class="c1"># build list of plots appropriate for `plotGrid`</span>
        <span class="n">plotlist</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">serum</span><span class="p">,</span> <span class="n">virus</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="n">sera</span><span class="p">,</span> <span class="n">viruses</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">virus</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">viruses</span><span class="p">[</span><span class="n">serum</span><span class="p">]:</span>
                <span class="n">title</span> <span class="o">=</span> <span class="n">subplot_titles</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">serum</span><span class="o">=</span><span class="n">serum</span><span class="p">,</span> <span class="n">virus</span><span class="o">=</span><span class="n">virus</span><span class="p">)</span>
                <span class="n">curvelist</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">replicate</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">replicates</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">replicate</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">replicates</span><span class="p">[(</span><span class="n">serum</span><span class="p">,</span> <span class="n">virus</span><span class="p">)]:</span>
                        <span class="n">curvelist</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;serum&#39;</span><span class="p">:</span> <span class="n">serum</span><span class="p">,</span>
                                          <span class="s1">&#39;virus&#39;</span><span class="p">:</span> <span class="n">virus</span><span class="p">,</span>
                                          <span class="s1">&#39;replicate&#39;</span><span class="p">:</span> <span class="n">replicate</span><span class="p">,</span>
                                          <span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="p">{</span><span class="kc">False</span><span class="p">:</span> <span class="n">replicate</span><span class="p">,</span>
                                                    <span class="kc">True</span><span class="p">:</span> <span class="kc">None</span><span class="p">}[</span><span class="n">average_only</span><span class="p">],</span>
                                          <span class="s1">&#39;color&#39;</span><span class="p">:</span> <span class="n">colors</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                                          <span class="s1">&#39;marker&#39;</span><span class="p">:</span> <span class="n">markers</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                                          <span class="p">})</span>
                <span class="k">if</span> <span class="n">curvelist</span><span class="p">:</span>
                    <span class="n">plotlist</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">title</span><span class="p">,</span> <span class="n">curvelist</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">plotlist</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;no curves for these sera / viruses&#39;</span><span class="p">)</span>

        <span class="c1"># get number of columns</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">nrow</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">ncol</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;either `ncol` or `nrow` must be `None`&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">nrow</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">and</span> <span class="n">nrow</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">ncol</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">plotlist</span><span class="p">)</span> <span class="o">/</span> <span class="n">nrow</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">ncol</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">and</span> <span class="n">ncol</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;`nrow` or `ncol` must be integer &gt; 0&#39;</span><span class="p">)</span>

        <span class="c1"># convert plotlist to plots dict for `plotGrid`</span>
        <span class="n">plots</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">iplot</span><span class="p">,</span> <span class="n">plot</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">plotlist</span><span class="p">):</span>
            <span class="n">plots</span><span class="p">[(</span><span class="n">iplot</span> <span class="o">//</span> <span class="n">ncol</span><span class="p">,</span> <span class="n">iplot</span> <span class="o">%</span> <span class="n">ncol</span><span class="p">)]</span> <span class="o">=</span> <span class="n">plot</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">plotGrid</span><span class="p">(</span><span class="n">plots</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_sera_viruses_lists</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sera</span><span class="p">,</span> <span class="n">viruses</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check and build lists of `sera` and their `viruses`.</span>

<span class="sd">        Args:</span>
<span class="sd">            `sera` (&#39;all&#39; or list)</span>
<span class="sd">            `viruses` (&#39;all&#39; or list)</span>

<span class="sd">        Returns:</span>
<span class="sd">            The 2-tuple `(sera, viruses)` which are checked lists.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">sera</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
            <span class="n">sera</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sera</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">extra_sera</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">sera</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sera</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">extra_sera</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;unrecognized sera: </span><span class="si">{extra_sera}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">allviruses</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">serum</span> <span class="ow">in</span> <span class="n">sera</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">virus</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">viruses</span><span class="p">[</span><span class="n">serum</span><span class="p">]:</span>
                <span class="n">allviruses</span><span class="p">[</span><span class="n">virus</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">allviruses</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">allviruses</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">viruses</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
            <span class="n">viruses</span> <span class="o">=</span> <span class="n">allviruses</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">extra_viruses</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">viruses</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">allviruses</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">extra_viruses</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;unrecognized viruses for specified &#39;</span>
                                 <span class="n">f</span><span class="s2">&quot;sera: </span><span class="si">{extra_viruses}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">sera</span><span class="p">,</span> <span class="n">viruses</span>

<div class="viewcode-block" id="CurveFits.plotGrid"><a class="viewcode-back" href="../../neutcurve.curvefits.html#neutcurve.curvefits.CurveFits.plotGrid">[docs]</a>    <span class="k">def</span> <span class="nf">plotGrid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">plots</span><span class="p">,</span>
                 <span class="o">*</span><span class="p">,</span>
                 <span class="n">xlabel</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">ylabel</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">widthscale</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                 <span class="n">heightscale</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                 <span class="n">attempt_shared_legend</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                 <span class="n">fix_lims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">bound_ymin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                 <span class="n">bound_ymax</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                 <span class="n">extend_lim</span><span class="o">=</span><span class="mf">0.07</span><span class="p">,</span>
                 <span class="n">markersize</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span>
                 <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                 <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span>
                 <span class="n">legendtitle</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Plot arbitrary grid of curves.</span>

<span class="sd">        Args:</span>
<span class="sd">            `plots` (dict)</span>
<span class="sd">                Plots to draw on grid. Keyed by 2-tuples `(irow, icol)`, which</span>
<span class="sd">                give row and column (0, 1, ... numbering) where plot should be</span>
<span class="sd">                drawn. Values are the 2-tuples `(title, curvelist)` where</span>
<span class="sd">                `title` is title for this plot (or `None`) and `curvelist`</span>
<span class="sd">                is a list of dicts keyed by:</span>

<span class="sd">                  - &#39;serum&#39;</span>
<span class="sd">                  - &#39;virus&#39;</span>
<span class="sd">                  - &#39;replicate&#39;</span>
<span class="sd">                  - &#39;label&#39;: label for this curve in legend, or `None`</span>
<span class="sd">                  - &#39;color&#39;</span>
<span class="sd">                  - &#39;marker&#39;: https://matplotlib.org/api/markers_api.html</span>

<span class="sd">            `xlabel`, `ylabel` (`None` or str)</span>
<span class="sd">                Labels for x- and y-axes. If `None`, use `conc_col`</span>
<span class="sd">                and `fracinf_col`, respectively.</span>
<span class="sd">            `widthscale`, `heightscale` (float)</span>
<span class="sd">                Scale width or height of figure by this much.</span>
<span class="sd">            `attempt_shared_legend` (bool)</span>
<span class="sd">                Share a single legend among plots if they all share</span>
<span class="sd">                in common the same label assigned to the same color / marker.</span>
<span class="sd">            `fix_lims` (dict or `None`)</span>
<span class="sd">                To fix axis limits, specify any of &#39;xmin&#39;, &#39;xmax&#39;, &#39;ymin&#39;,</span>
<span class="sd">                or &#39;ymax&#39; with specified limit.</span>
<span class="sd">            `bound_ymin`, `bound_ymax` (float or `None`)</span>
<span class="sd">                Make y-axis min and max at least this small / large.</span>
<span class="sd">                Ignored if using `fix_lims` for that axis limit.</span>
<span class="sd">            `extend_lim` (float)</span>
<span class="sd">                For all axis limits not in `fix_lims`, extend this fraction</span>
<span class="sd">                of range above and below bounds / data limits.</span>
<span class="sd">            `markersize` (float)</span>
<span class="sd">                Size of point marker.</span>
<span class="sd">            `linewidth` (float)</span>
<span class="sd">                Width of line.</span>
<span class="sd">            `linestyle` (str)</span>
<span class="sd">                Line style.</span>
<span class="sd">            `legendtitle` (str or `None`)</span>
<span class="sd">                Title of legend.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The 2-tuple `(fig, axes)` of matplotlib figure and 2D axes array.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">plots</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;empty `plots`&#39;</span><span class="p">)</span>

        <span class="c1"># get number of rows / cols, curves, and data limits</span>
        <span class="n">nrows</span> <span class="o">=</span> <span class="n">ncols</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">fix_lims</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fix_lims</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">lims</span> <span class="o">=</span> <span class="n">fix_lims</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">bound_ymin</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">lims</span><span class="p">[</span><span class="s1">&#39;ymin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bound_ymin</span>
        <span class="k">if</span> <span class="n">bound_ymax</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">lims</span><span class="p">[</span><span class="s1">&#39;ymax&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bound_ymax</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">irow</span><span class="p">,</span> <span class="n">icol</span><span class="p">),</span> <span class="p">(</span><span class="n">_title</span><span class="p">,</span> <span class="n">curvelist</span><span class="p">)</span> <span class="ow">in</span> <span class="n">plots</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">irow</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;invalid row index `irow` &lt; 0&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">icol</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;invalid row index `icol` &lt; 0&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">nrows</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">nrows</span> <span class="o">=</span> <span class="n">irow</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">nrows</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">nrows</span><span class="p">,</span> <span class="n">irow</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ncols</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">ncols</span> <span class="o">=</span> <span class="n">icol</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ncols</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">ncols</span><span class="p">,</span> <span class="n">icol</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">curvedict</span> <span class="ow">in</span> <span class="n">curvelist</span><span class="p">:</span>
                <span class="n">curve</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getCurve</span><span class="p">(</span><span class="n">serum</span><span class="o">=</span><span class="n">curvedict</span><span class="p">[</span><span class="s1">&#39;serum&#39;</span><span class="p">],</span>
                                      <span class="n">virus</span><span class="o">=</span><span class="n">curvedict</span><span class="p">[</span><span class="s1">&#39;virus&#39;</span><span class="p">],</span>
                                      <span class="n">replicate</span><span class="o">=</span><span class="n">curvedict</span><span class="p">[</span><span class="s1">&#39;replicate&#39;</span><span class="p">]</span>
                                      <span class="p">)</span>
                <span class="n">curvedict</span><span class="p">[</span><span class="s1">&#39;curve&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">curve</span>
                <span class="k">for</span> <span class="n">lim</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">limfunc</span><span class="p">,</span> <span class="ow">in</span> <span class="p">[(</span><span class="s1">&#39;xmin&#39;</span><span class="p">,</span> <span class="s1">&#39;cs&#39;</span><span class="p">,</span> <span class="nb">min</span><span class="p">),</span>
                                            <span class="p">(</span><span class="s1">&#39;xmax&#39;</span><span class="p">,</span> <span class="s1">&#39;cs&#39;</span><span class="p">,</span> <span class="nb">max</span><span class="p">),</span>
                                            <span class="p">(</span><span class="s1">&#39;ymin&#39;</span><span class="p">,</span> <span class="s1">&#39;fs&#39;</span><span class="p">,</span> <span class="nb">min</span><span class="p">),</span>
                                            <span class="p">(</span><span class="s1">&#39;ymax&#39;</span><span class="p">,</span> <span class="s1">&#39;fs&#39;</span><span class="p">,</span> <span class="nb">max</span><span class="p">)</span>
                                            <span class="p">]:</span>
                    <span class="n">val</span> <span class="o">=</span> <span class="n">limfunc</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">curve</span><span class="p">,</span> <span class="n">attr</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">lim</span> <span class="ow">in</span> <span class="n">fix_lims</span><span class="p">:</span>
                        <span class="k">pass</span>
                    <span class="k">elif</span> <span class="n">lim</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">lims</span><span class="p">:</span>
                        <span class="n">lims</span><span class="p">[</span><span class="n">lim</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">lims</span><span class="p">[</span><span class="n">lim</span><span class="p">]</span> <span class="o">=</span> <span class="n">limfunc</span><span class="p">(</span><span class="n">lims</span><span class="p">[</span><span class="n">lim</span><span class="p">],</span> <span class="n">val</span><span class="p">)</span>

        <span class="c1"># check and then extend limits</span>
        <span class="k">if</span> <span class="n">lims</span><span class="p">[</span><span class="s1">&#39;xmin&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;xmin </span><span class="si">{lims[&#39;xmin&#39;]}</span><span class="s2"> &lt;= 0, which is not allowed&quot;</span><span class="p">)</span>
        <span class="n">yextent</span> <span class="o">=</span> <span class="n">lims</span><span class="p">[</span><span class="s1">&#39;ymax&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">lims</span><span class="p">[</span><span class="s1">&#39;ymin&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">yextent</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;no positive extent for y-axis&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;ymin&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">fix_lims</span><span class="p">:</span>
            <span class="n">lims</span><span class="p">[</span><span class="s1">&#39;ymin&#39;</span><span class="p">]</span> <span class="o">-=</span> <span class="n">yextent</span> <span class="o">*</span> <span class="n">extend_lim</span>
        <span class="k">if</span> <span class="s1">&#39;ymax&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">fix_lims</span><span class="p">:</span>
            <span class="n">lims</span><span class="p">[</span><span class="s1">&#39;ymax&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">yextent</span> <span class="o">*</span> <span class="n">extend_lim</span>
        <span class="n">xextent</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">lims</span><span class="p">[</span><span class="s1">&#39;xmax&#39;</span><span class="p">])</span> <span class="o">-</span> <span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">lims</span><span class="p">[</span><span class="s1">&#39;xmin&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">xextent</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;no positive extent for x-axis&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;xmin&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">fix_lims</span><span class="p">:</span>
            <span class="n">lims</span><span class="p">[</span><span class="s1">&#39;xmin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">lims</span><span class="p">[</span><span class="s1">&#39;xmin&#39;</span><span class="p">])</span> <span class="o">-</span>
                                    <span class="n">xextent</span> <span class="o">*</span> <span class="n">extend_lim</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;xmax&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">fix_lims</span><span class="p">:</span>
            <span class="n">lims</span><span class="p">[</span><span class="s1">&#39;xmax&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">lims</span><span class="p">[</span><span class="s1">&#39;xmax&#39;</span><span class="p">])</span> <span class="o">+</span>
                                    <span class="n">xextent</span> <span class="o">*</span> <span class="n">extend_lim</span><span class="p">)</span>

        <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="n">nrows</span><span class="p">,</span>
                                 <span class="n">ncols</span><span class="o">=</span><span class="n">ncols</span><span class="p">,</span>
                                 <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                 <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                 <span class="n">squeeze</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                 <span class="n">figsize</span><span class="o">=</span><span class="p">((</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">ncols</span><span class="p">)</span> <span class="o">*</span> <span class="n">widthscale</span><span class="p">,</span>
                                          <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="mf">2.25</span> <span class="o">*</span> <span class="n">nrows</span><span class="p">)</span> <span class="o">*</span> <span class="n">heightscale</span><span class="p">),</span>
                                 <span class="p">)</span>

        <span class="c1"># set limits on shared axis</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">lims</span><span class="p">[</span><span class="s1">&#39;xmin&#39;</span><span class="p">],</span> <span class="n">lims</span><span class="p">[</span><span class="s1">&#39;xmax&#39;</span><span class="p">])</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">lims</span><span class="p">[</span><span class="s1">&#39;ymin&#39;</span><span class="p">],</span> <span class="n">lims</span><span class="p">[</span><span class="s1">&#39;ymax&#39;</span><span class="p">])</span>

        <span class="c1"># make plots</span>
        <span class="n">shared_legend</span> <span class="o">=</span> <span class="n">attempt_shared_legend</span>
        <span class="n">kwargs_tup_to_label</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># used to determine if shared legend</span>
        <span class="n">legend_handles</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
        <span class="n">shared_legend_handles</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># handles if using shared legend</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">irow</span><span class="p">,</span> <span class="n">icol</span><span class="p">),</span> <span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">curvelist</span><span class="p">)</span> <span class="ow">in</span> <span class="n">plots</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">irow</span><span class="p">,</span> <span class="n">icol</span><span class="p">]</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">curvedict</span> <span class="ow">in</span> <span class="n">curvelist</span><span class="p">:</span>
                <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;color&#39;</span><span class="p">:</span> <span class="n">curvedict</span><span class="p">[</span><span class="s1">&#39;color&#39;</span><span class="p">],</span>
                          <span class="s1">&#39;marker&#39;</span><span class="p">:</span> <span class="n">curvedict</span><span class="p">[</span><span class="s1">&#39;marker&#39;</span><span class="p">],</span>
                          <span class="s1">&#39;linestyle&#39;</span><span class="p">:</span> <span class="n">linestyle</span><span class="p">,</span>
                          <span class="s1">&#39;linewidth&#39;</span><span class="p">:</span> <span class="n">linewidth</span><span class="p">,</span>
                          <span class="s1">&#39;markersize&#39;</span><span class="p">:</span> <span class="n">markersize</span><span class="p">,</span>
                          <span class="p">}</span>
                <span class="n">curvedict</span><span class="p">[</span><span class="s1">&#39;curve&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
                                        <span class="n">xlabel</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                        <span class="n">ylabel</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
                                        <span class="p">)</span>
                <span class="n">label</span> <span class="o">=</span> <span class="n">curvedict</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">label</span><span class="p">:</span>
                    <span class="n">handle</span> <span class="o">=</span> <span class="n">Line2D</span><span class="p">(</span><span class="n">xdata</span><span class="o">=</span><span class="p">[],</span>
                                    <span class="n">ydata</span><span class="o">=</span><span class="p">[],</span>
                                    <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span>
                                    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
                                    <span class="p">)</span>
                    <span class="n">legend_handles</span><span class="p">[(</span><span class="n">irow</span><span class="p">,</span> <span class="n">icol</span><span class="p">)]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">shared_legend</span><span class="p">:</span>
                        <span class="n">kwargs_tup</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">()))</span>
                        <span class="k">if</span> <span class="n">kwargs_tup</span> <span class="ow">in</span> <span class="n">kwargs_tup_to_label</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">kwargs_tup_to_label</span><span class="p">[</span><span class="n">kwargs_tup</span><span class="p">]</span> <span class="o">!=</span> <span class="n">label</span><span class="p">:</span>
                                <span class="n">shared_legend</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">kwargs_tup_to_label</span><span class="p">[</span><span class="n">kwargs_tup</span><span class="p">]</span> <span class="o">=</span> <span class="n">label</span>
                            <span class="n">shared_legend_handles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span>
        <span class="c1"># draw legend(s)</span>
        <span class="n">legend_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;fontsize&#39;</span><span class="p">:</span> <span class="mi">12</span><span class="p">,</span>
                         <span class="s1">&#39;numpoints&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                         <span class="s1">&#39;markerscale&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                         <span class="s1">&#39;handlelength&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                         <span class="s1">&#39;labelspacing&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">,</span>
                         <span class="s1">&#39;handletextpad&#39;</span><span class="p">:</span> <span class="mf">0.4</span><span class="p">,</span>
                         <span class="s1">&#39;frameon&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                         <span class="s1">&#39;borderaxespad&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">,</span>
                         <span class="s1">&#39;borderpad&#39;</span><span class="p">:</span> <span class="mf">0.2</span><span class="p">,</span>
                         <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="n">legendtitle</span><span class="p">,</span>
                         <span class="s1">&#39;title_fontsize&#39;</span><span class="p">:</span> <span class="mi">13</span><span class="p">,</span>
                         <span class="s1">&#39;framealpha&#39;</span><span class="p">:</span> <span class="mf">0.6</span><span class="p">,</span>
                         <span class="p">}</span>
        <span class="k">if</span> <span class="n">shared_legend</span> <span class="ow">and</span> <span class="n">shared_legend_handles</span><span class="p">:</span>
            <span class="c1"># shared legend as here: https://stackoverflow.com/a/17328230</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handles</span><span class="o">=</span><span class="n">shared_legend_handles</span><span class="p">,</span>
                       <span class="n">labels</span><span class="o">=</span><span class="p">[</span><span class="n">h</span><span class="o">.</span><span class="n">get_label</span><span class="p">()</span> <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">shared_legend_handles</span><span class="p">],</span>
                       <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;center left&#39;</span><span class="p">,</span>
                       <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">),</span>
                       <span class="n">bbox_transform</span><span class="o">=</span><span class="n">fig</span><span class="o">.</span><span class="n">transFigure</span><span class="p">,</span>
                       <span class="o">**</span><span class="n">legend_kwargs</span><span class="p">,</span>
                       <span class="p">)</span>
        <span class="k">elif</span> <span class="n">legend_handles</span><span class="p">:</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">irow</span><span class="p">,</span> <span class="n">icol</span><span class="p">),</span> <span class="n">handles</span> <span class="ow">in</span> <span class="n">legend_handles</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">irow</span><span class="p">,</span> <span class="n">icol</span><span class="p">]</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handles</span><span class="o">=</span><span class="n">handles</span><span class="p">,</span>
                          <span class="n">labels</span><span class="o">=</span><span class="p">[</span><span class="n">h</span><span class="o">.</span><span class="n">get_label</span><span class="p">()</span> <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">handles</span><span class="p">],</span>
                          <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;lower left&#39;</span><span class="p">,</span>
                          <span class="o">**</span><span class="n">legend_kwargs</span><span class="p">,</span>
                          <span class="p">)</span>

        <span class="c1"># hide unused axes</span>
        <span class="k">for</span> <span class="n">irow</span><span class="p">,</span> <span class="n">icol</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">nrows</span><span class="p">),</span> <span class="nb">range</span><span class="p">(</span><span class="n">ncols</span><span class="p">)):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">irow</span><span class="p">,</span> <span class="n">icol</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">plots</span><span class="p">:</span>
                <span class="n">axes</span><span class="p">[</span><span class="n">irow</span><span class="p">,</span> <span class="n">icol</span><span class="p">]</span><span class="o">.</span><span class="n">set_axis_off</span><span class="p">()</span>

        <span class="c1"># common axis labels as here: https://stackoverflow.com/a/53172335</span>
        <span class="n">bigax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">,</span> <span class="n">frameon</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">bigax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">bigax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">labelcolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">bottom</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                          <span class="n">left</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">xlabel</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">bigax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conc_col</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">labelpad</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">bigax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">xlabel</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">labelpad</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ylabel</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">bigax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fracinf_col</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">labelpad</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">bigax</span><span class="o">.</span><span class="n">set_yabel</span><span class="p">(</span><span class="n">ylabel</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">labelpad</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

        <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span></div></div>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">doctest</span>
    <span class="n">doctest</span><span class="o">.</span><span class="n">testmod</span><span class="p">()</span>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<p class="logo">
  <a href="../../index.html">
    <img class="logo" src="../../_static/BloomLogo.jpg" alt="Logo"/>
    
    <h1 class="logo logo-name">neutcurve</h1>
    
  </a>
</p>



<p class="blurb">Fit and plot neutralization curves</p>




<p>
<iframe src="https://ghbtns.com/github-btn.html?user=jbloomlab&repo=neutcurve&type=watch&count=true&size=large&v=2"
  allowtransparency="true" frameborder="0" scrolling="0" width="200px" height="35px"></iframe>
</p>





    

<p>
<a class="badge" href="https://travis-ci.org/jbloomlab/neutcurve">
    <img
        alt="https://secure.travis-ci.org/jbloomlab/neutcurve.svg?branch=master"
        src="https://secure.travis-ci.org/jbloomlab/neutcurve.svg?branch=master"
    />
</a>
</p>


<h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../index.html">neutcurve documentation</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../hillcurve_example.html">Hill-curve neutralization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../curvefits_example.html">Fitting curves to real data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../raw_examples.html">Raw data from plate reader</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../neutcurve.html">neutcurve package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../package_index.html">package index</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../acknowledgments.html">Acknowledgements</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2019--2019, Bloom lab.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.8.2</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    
    <a href="https://github.com/jbloomlab/neutcurve" class="github">
        <img style="position: absolute; top: 0; right: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_right_darkblue_121621.png" alt="Fork me on GitHub"  class="github"/>
    </a>
    

    
  </body>
</html>